"""
–£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –∞–≥–µ–Ω—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–æ–±—ã—Ç–∏–π
"""

import logging
from typing import Annotated

from langchain_core.tools import tool
from langgraph.prebuilt import InjectedState

from .nodes.simple_events import (
    simple_calendar_status,
    simple_list_events,
    simple_create_event,
    simple_delete_event,
    simple_get_available_slots
)

from .nodes.improved_events import (
    improved_list_events,
    search_events_by_keywords,
    delete_events_by_keywords
)

logger = logging.getLogger(__name__)


@tool
async def improved_calendar_agent(
    user_request: str,
    user_id: str = "default_user",
    state: Annotated[dict, InjectedState] = None
):
    """
    –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Calendar —á–µ—Ä–µ–∑ Service Account
    
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º:
    - –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–±—ã—Ç–∏–π –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è)
    - –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
    - –ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    - –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—à–µ–¥—à–∏–µ)
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
    
    Args:
        user_request: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è", "–Ω–∞–π—Ç–∏ —Å–æ–±—ã—Ç–∏—è —Å git", "—É–¥–∞–ª–∏—Ç—å –ø—Ä–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è")
        user_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    """
    
    try:
        user_input = user_request.lower()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        if any(phrase in user_input for phrase in ["—Å—Ç–∞—Ç—É—Å –∫–∞–ª–µ–Ω–¥–∞—Ä", "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å", "–ø–æ–¥–∫–ª—é—á–µ–Ω –ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å", "–∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω"]):
            result = await simple_calendar_status.ainvoke({})
            return result
            
        # –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–æ—à–µ–¥—à–∏–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏)
        elif any(phrase in user_input for phrase in ["–ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è", "–ø–æ–∫–∞–∂–∏ —Å–æ–±—ã—Ç–∏—è", "—Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π", "–≤—Å–µ —Å–æ–±—ã—Ç–∏—è"]):
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–∫–ª—é—á–∞—Ç—å –ø—Ä–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è
            include_past = any(phrase in user_input for phrase in ["–ø—Ä–æ—à–µ–¥—à–∏–µ", "–ø—Ä–æ—à–ª—ã–µ", "–≤—Å–µ", "–≤–∫–ª—é—á–∞—è –ø—Ä–æ—à–ª—ã–µ"])
            days_back = 30 if include_past else 7
            
            result = await improved_list_events.ainvoke({
                "max_results": 50,
                "days_back": days_back,
                "include_past": include_past
            })
            return result
            
        # –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∞ –º–µ—Å—è—Ü
        elif any(phrase in user_input for phrase in ["—Å–æ–±—ã—Ç–∏—è –Ω–∞ –º–µ—Å—è—Ü", "–º–µ—Å—è—Ü –≤–ø–µ—Ä–µ–¥", "–Ω–∞ –º–µ—Å—è—Ü"]):
            result = await improved_list_events.ainvoke({
                "max_results": 100,
                "days_back": 30,
                "include_past": True
            })
            return result
            
        # –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é
        elif any(phrase in user_input for phrase in ["—Å–æ–±—ã—Ç–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é", "–Ω–µ–¥–µ–ª—è –≤–ø–µ—Ä–µ–¥", "–Ω–∞ –Ω–µ–¥–µ–ª—é"]):
            result = await improved_list_events.ainvoke({
                "max_results": 50,
                "days_back": 7,
                "include_past": True
            })
            return result
            
        # –ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        elif any(phrase in user_input for phrase in ["–Ω–∞–π—Ç–∏ —Å–æ–±—ã—Ç–∏–µ", "–Ω–∞–π–¥–∏ —Å–æ–±—ã—Ç–∏–µ", "–ø–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π", "—Å–æ–±—ã—Ç–∏—è —Å"]):
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
            keywords = extract_keywords_from_request(user_input)
            if not keywords:
                return """üîç **–ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π**
                
–î–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π —É–∫–∞–∂–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
‚Ä¢ "–Ω–∞–π—Ç–∏ —Å–æ–±—ã—Ç–∏–µ —Å git"
‚Ä¢ "–Ω–∞–π–¥–∏ —Å–æ–±—ã—Ç–∏—è —Å github"
‚Ä¢ "–ø–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π —Å –º–æ–Ω—Ç–∞–∂"

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ø–æ–∏—Å–∫ –≤ –ø—Ä–æ—à–µ–¥—à–∏—Ö –∏ –±—É–¥—É—â–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö."""
            
            result = await search_events_by_keywords.ainvoke({
                "keywords": keywords,
                "max_results": 50,
                "days_back": 30,
                "include_past": True
            })
            return result
            
        # –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        elif any(phrase in user_input for phrase in ["—É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ", "—É–¥–∞–ª–∏ —Å–æ–±—ã—Ç–∏–µ", "–æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ", "—É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏—è —Å"]):
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
            keywords = extract_keywords_from_request(user_input)
            if not keywords:
                return """üóëÔ∏è **–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è**
                
–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π —É–∫–∞–∂–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
‚Ä¢ "—É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ —Å git"
‚Ä¢ "—É–¥–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è —Å github"
‚Ä¢ "–æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏—è —Å –º–æ–Ω—Ç–∞–∂"

‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!"""
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            has_confirm = any(phrase in user_input for phrase in ["–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é", "–¥–∞", "yes", "—É–¥–∞–ª–∏—Ç—å"])
            
            if not has_confirm:
                return f"""‚ö†Ô∏è **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è**

–í—ã —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏—è —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏: **{keywords}**

–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é" –∏–ª–∏ "–¥–∞" –∫ –∑–∞–ø—Ä–æ—Å—É, –Ω–∞–ø—Ä–∏–º–µ—Ä:
"—É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏—è —Å {keywords} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é"

‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!"""
            
            result = await delete_events_by_keywords.ainvoke({
                "keywords": keywords,
                "days_back": 30,
                "include_past": True,
                "confirm": True
            })
            return result
            
        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        elif any(phrase in user_input for phrase in ["—Å–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ", "—Å–æ–∑–¥–∞–π —Å–æ–±—ã—Ç–∏–µ", "–¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ", "–Ω–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞"]):
            return """‚ûï **–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è**
            
–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç simple_create_event —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
‚Ä¢ title: –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
‚Ä¢ start_datetime: –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "20.01.2025 15:00")
‚Ä¢ end_datetime: –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "20.01.2025 16:00")
‚Ä¢ description: –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

–ü—Ä–∏–º–µ—Ä: "—Å–æ–∑–¥–∞–π —Å–æ–±—ã—Ç–∏–µ '–≤—Å—Ç—Ä–µ—á–∞' –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤ 15:00" """
            
        # –°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã
        elif any(phrase in user_input for phrase in ["—Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã", "—Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è", "–¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è"]):
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
            date = extract_date_from_request(user_input)
            if not date:
                return """üïê **–°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã**
                
–î–ª—è –ø–æ–∏—Å–∫–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ —É–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É, –Ω–∞–ø—Ä–∏–º–µ—Ä:
‚Ä¢ "—Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã –Ω–∞ 20.01.2025"
‚Ä¢ "—Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞"
‚Ä¢ "–¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" """
            
            result = await simple_get_available_slots.ainvoke({
                "date": date
            })
            return result
            
        else:
            return """üìÖ **–£–ª—É—á—à–µ–Ω–Ω—ã–π Google Calendar Agent**

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
‚Ä¢ "–ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è" - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—à–µ–¥—à–∏–µ)
‚Ä¢ "–ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∞ –º–µ—Å—è—Ü" - —Å–æ–±—ã—Ç–∏—è –Ω–∞ –º–µ—Å—è—Ü –≤–ø–µ—Ä–µ–¥
‚Ä¢ "–ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é" - —Å–æ–±—ã—Ç–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é
‚Ä¢ "–Ω–∞–π—Ç–∏ —Å–æ–±—ã—Ç–∏–µ —Å [–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞]" - –ø–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
‚Ä¢ "—É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ —Å [–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞]" - —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
‚Ä¢ "—Å–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ" - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
‚Ä¢ "—Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã –Ω–∞ [–¥–∞—Ç–∞]" - –ø–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è
‚Ä¢ "—Å—Ç–∞—Ç—É—Å –∫–∞–ª–µ–Ω–¥–∞—Ä—è" - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ "–ø–æ–∫–∞–∂–∏ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤–∫–ª—é—á–∞—è –ø—Ä–æ—à–ª—ã–µ"
‚Ä¢ "–Ω–∞–π–¥–∏ —Å–æ–±—ã—Ç–∏—è —Å git"
‚Ä¢ "—É–¥–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è —Å github –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é"
‚Ä¢ "—Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã –Ω–∞ 20.01.2025"
‚Ä¢ "—Å–æ–∑–¥–∞–π –≤—Å—Ç—Ä–µ—á—É –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤ 15:00"

üÜï –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
‚Ä¢ –ü–æ–∏—Å–∫ –≤ –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö
‚Ä¢ –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é"""
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ improved_calendar_agent: {e}")
        return f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}"


def extract_keywords_from_request(user_input: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞ "—Å git", "—Å github", "—Å –º–æ–Ω—Ç–∞–∂"
    import re
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    patterns = [
        r"—Å\s+([–∞-—è—ë\w\s]+?)(?:\s|$|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é|–¥–∞)",
        r"–ø–æ\s+([–∞-—è—ë\w\s]+?)(?:\s|$|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é|–¥–∞)",
        r"—Å–æ–¥–µ—Ä–∂–∞—â–∏–µ\s+([–∞-—è—ë\w\s]+?)(?:\s|$|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é|–¥–∞)",
        r"–≤–∫–ª—é—á–∞—é—â–∏–µ\s+([–∞-—è—ë\w\s]+?)(?:\s|$|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é|–¥–∞)"
    ]
    
    for pattern in patterns:
        match = re.search(pattern, user_input, re.IGNORECASE)
        if match:
            keywords = match.group(1).strip()
            # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤
            keywords = re.sub(r'\b(—Å–æ–±—ã—Ç–∏—è?|—Å–æ–±—ã—Ç–∏–µ)\b', '', keywords, flags=re.IGNORECASE).strip()
            if keywords:
                return keywords
    
    return ""


def extract_date_from_request(user_input: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞—Ç—É –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    import re
    from datetime import datetime, timedelta
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞—Ç—ã
    patterns = [
        r"(\d{1,2}\.\d{1,2}\.\d{4})",  # 20.01.2025
        r"(\d{1,2}\.\d{1,2})",         # 20.01 (—Ç–µ–∫—É—â–∏–π –≥–æ–¥)
    ]
    
    for pattern in patterns:
        match = re.search(pattern, user_input)
        if match:
            date_str = match.group(1)
            try:
                if len(date_str.split('.')) == 2:
                    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≥–æ–¥
                    current_year = datetime.now().year
                    date_str = f"{date_str}.{current_year}"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞
                datetime.strptime(date_str, "%d.%m.%Y")
                return date_str
            except ValueError:
                continue
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    if "–∑–∞–≤—Ç—Ä–∞" in user_input:
        tomorrow = datetime.now() + timedelta(days=1)
        return tomorrow.strftime("%d.%m.%Y")
    elif "—Å–µ–≥–æ–¥–Ω—è" in user_input:
        today = datetime.now()
        return today.strftime("%d.%m.%Y")
    
    return ""


# –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
IMPROVED_CALENDAR_PROMPT = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∞–±–æ—Ç–µ —Å Google Calendar —á–µ—Ä–µ–∑ Service Account.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º:
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è)
- –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
- –ò—Å–∫–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
- –£–¥–∞–ª—è—Ç—å —Å–æ–±—ã—Ç–∏—è (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—à–µ–¥—à–∏–µ)
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å –∫–∞–ª–µ–Ω–¥–∞—Ä—è
- –ù–∞—Ö–æ–¥–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã

üÜï –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ü–æ–∏—Å–∫ –≤ –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é

–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —É–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–±—ã—Ç–∏—è–º–∏."""
