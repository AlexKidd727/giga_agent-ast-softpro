volumes:
    aegra-data:
        driver: local
    front_node_modules:
services:
    langgraph-redis:
        image: redis:6
        healthcheck:
            test: redis-cli ping
            interval: 5s
            timeout: 1s
            retries: 5
    aegra-postgres:
        image: postgres:16
        environment:
            POSTGRES_DB: postgres
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
        volumes:
            - aegra-data:/var/lib/postgresql/data
        healthcheck:
            test: pg_isready -U postgres
            start_period: 10s
            timeout: 1s
            retries: 5
            interval: 5s
    langgraph-api:
        build:
            context: ./backend/graph
        image: giga_agent_aegra
        pull_policy: never
        depends_on:
            aegra-postgres:
                condition: service_healthy
        env_file:
            - .docker.env
        environment:
            REDIS_URI: redis://langgraph-redis:6379
            DATABASE_URL: postgresql+asyncpg://postgres:postgres@aegra-postgres:5432/postgres
            AUTH_TYPE: noop
            JUPYTER_CLIENT_API: http://repl:9090
            TOOL_CLIENT_API: http://tool_server:9091
        volumes:
            - ./backend/graph/giga_agent:/app/giga_agent:rw
            - ./backend/graph/langgraph.json:/aegra.json:ro
        command: >
            sh -c "
              echo 'Running database migrations...' &&
              alembic upgrade head &&
              echo 'Starting Aegra server...' &&
              uv run uvicorn src.agent_server.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/giga_agent
            "
    repl:
        working_dir: /
        restart: always
        build:
            context: ./backend/repl
        image: repl:latest
        pull_policy: never
        user: jupyter
        command: uv run uvicorn app.main:app --host 0.0.0.0 --port 9090 --reload --reload-dir /app
        environment:
            PLOTLY_RENDERER: plotly_mimetype
            MAX_KERNEL_LIVE: 300
            FILES_DIR: /files
            STATE_DIR: /kernel_states
        volumes:
            - ./kernel_states/:/kernel_states/
            - ./files/:/files/:ro
            - ./backend/repl/app:/app:rw
            - ./backend/repl/models:/models:ro
            - ./data/jupyter:/home/jupyter/
            - ./data/runs:/runs/:ro
    upload_server:
        working_dir: /
        restart: always
        image: repl:latest
        user: root
        pull_policy: never
        depends_on:
            - repl
        command: uv run uvicorn app.upload_server:app --host 0.0.0.0 --port 9092 --reload --reload-dir /app
        env_file:
            - .docker.env
        environment:
            PLOTLY_RENDERER: plotly_mimetype
            MAX_KERNEL_LIVE: 300
            FILES_DIR: /files
            STATE_DIR: /kernel_states
        volumes:
            - ./files/:/files/:rw
            - ./data/runs:/runs/:rw
            - ./backend/repl/app:/app:rw
    tool_server:
        working_dir: /app
        restart: always
        image: giga_agent_aegra
        pull_policy: never
        command: uv run uvicorn giga_agent.tool_server.tool_server:app --host 0.0.0.0 --port 9091 --reload --reload-dir /app/giga_agent
        env_file:
            - .docker.env
        entrypoint: []
        environment:
            JUPYTER_CLIENT_API: http://repl:9090
            TOOL_CLIENT_API: http://tool_server:9091
        volumes:
            - ./backend/graph/giga_agent:/app/giga_agent:rw
    frontend:
        image: nginx:alpine
        ports:
            - "8502:80"
        volumes:
            - ./front/nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro
            - ./files/:/files/:ro
            - ./data/jupyter:/home/jupyter/:ro
            - ./data/runs:/runs/:ro
        depends_on:
            langgraph-api:
                condition: service_started
            repl:
                condition: service_started
            tool_server:
                condition: service_started
            frontend-dev:
                condition: service_started

    frontend-dev:
        image: node:22.12-alpine
        command: npm run dev -- --host 0.0.0.0 --port 3000
        build:
            context: ./front
            dockerfile: DockerfileDev
        volumes:
            - ./front/public:/app/public:rw
            - ./front/src:/app/src:rw
            - ./front/index.html:/app/index.html:ro